---
import MainLayout from '@/layouts/MainLayout.astro'
import SpeakerTabBtn from '@components/ui/buttons/SpeakerTabBtn.astro'
import BackButton from '@/components/sections/misc/BackButton.astro'
import PrimaryCTA from '@components/ui/buttons/PrimaryCTA.astro'
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'
import { SITE } from '@data/constants'

import combinedSpeakersImg from '@images/speakers/combined-speakers.png'

// Static paths
export async function getStaticPaths() {
  const speakerEntries = await getCollection('speakers')
  return speakerEntries.map((speaker) => ({
    params: { slug: speaker.slug },
    props: { speaker },
  }))
}

const { speaker } = Astro.props
const pageTitle = `${speaker.data.title} | ${SITE.title}`
---

<MainLayout
  title={pageTitle}
  meta={[
    // Adding Open Graph (OG) tags
    { property: 'og:title', content: speaker.data.title },
    { property: 'og:description', content: speaker.data.description },
    { property: 'og:type', content: 'website' },
    { property: 'og:url', content: `${SITE.url}speakers/${speaker.slug}` },
    {
      property: 'og:image',
      content: combinedSpeakersImg.src,
    },
  ]}
>
  <div
    class="pointer-events-none fixed inset-0 bg-neutral-200 opacity-0 dark:bg-neutral-800"
    aria-hidden="true"></div>
  <div class="mx-auto -ml-0.5 mt-12 max-w-[85rem] px-4 pt-4 sm:px-6 lg:px-8">
    <BackButton label="Back to speakers" />
  </div>

  <section
    class="mx-auto flex max-w-[85rem] flex-col px-4 py-6 sm:px-6 lg:px-8 lg:py-10 2xl:max-w-full"
  >
    <div
      class="flex flex-col-reverse items-center justify-between gap-8 sm:flex-row sm:gap-4"
    >
      <!-- TEXT -->
      <div
        class="will-change-opacity max-w-2xl animate-fade-in-left opacity-0 will-change-transform"
      >
        <h1
          class="block text-4xl font-bold tracking-tighter text-neutral-800 dark:text-neutral-200 sm:text-5xl md:text-6xl lg:text-7xl"
        >
          {speaker.data.title}
        </h1>

        <p class="mt-3 text-lg text-neutral-600 dark:text-neutral-400">
          {speaker.data.description}
        </p>

        <p
          class="mt-6 max-w-prose animate-fade-in-left text-pretty font-light text-neutral-700 opacity-0 [animation-delay:400ms] dark:text-neutral-300 sm:text-lg"
        >
          {speaker.data.main?.content ?? ''}
        </p>

        <div
          class="mt-6 animate-fade-in-left opacity-0 [animation-delay:600ms]"
        >
          <PrimaryCTA
            title={speaker.data.longDescription?.btnTitle ?? 'Learn more'}
            url={speaker.data.longDescription?.btnURL ?? '#'}
          />
        </div>
      </div>

      <!-- IMAGE -->
      <div
        class="will-change-opacity w-full max-w-[640px] animate-fade-in-right overflow-hidden rounded-xl bg-neutral-900 opacity-0 shadow-lg will-change-transform [animation-delay:200ms]"
      >
        <Image
          src={speaker.data.main.imgMain}
          alt={speaker.data.main.imgAlt ?? speaker.data.title}
          class="speaker-clip h-[420px] min-h-[220px] w-full scale-[1.01] object-cover object-[center_20%]"
          format="avif"
          loading="eager"
        />
      </div>
    </div>
  </section>

  <!-- TABS
       Reduced top padding and ensure nav is above any overlays by giving it z-index.
       Also keep compact spacing so the nav doesn't push contents down too much. -->
  <div class="mx-auto max-w-[85rem] px-4 pt-6 sm:px-6 lg:px-8 lg:pt-8">
    <nav
      class="relative z-20 mx-auto grid max-w-6xl gap-y-px sm:flex sm:gap-x-4"
      aria-label="Tabs"
      role="tablist"
    >
      {
        speaker.data.tabs.map((tab, index) => (
          <SpeakerTabBtn
            title={tab.title}
            id={tab.id}
            dataTab={tab.dataTab}
            first={index === 0}
          />
        ))
      }
    </nav>

    <div class="mt-8 md:mt-10">
      <!-- PANEL 1 -->
      <div id="tabs-with-card-1" role="tabpanel">
        <div class="mx-auto max-w-[85rem] px-4 pb-8 sm:px-6 lg:px-8 lg:pb-12">
          <div class="grid gap-10 md:grid-cols-2">
            <div class="lg:w-3/4">
              <h2
                class="text-balance text-3xl font-bold tracking-tight text-neutral-800 dark:text-neutral-200 lg:text-4xl"
              >
                {speaker.data.longDescription?.title ?? ''}
              </h2>

              <p class="mt-3 text-neutral-600 dark:text-neutral-400">
                {speaker.data.longDescription?.subTitle ?? ''}
              </p>
            </div>

            <div class="space-y-6">
              {
                speaker.data.descriptionList.map((list) => (
                  <div>
                    <h3 class="font-bold text-neutral-800 dark:text-neutral-200">
                      {list.title}
                    </h3>
                    <p class="mt-1 text-neutral-600 dark:text-neutral-400">
                      {list.subTitle}
                    </p>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- PANEL 2 -->
      <div id="tabs-with-card-2" class="hidden" role="tabpanel">
        <div class="mx-auto max-w-[85rem] px-4 pb-8 sm:px-6 lg:px-8 lg:pb-12">
          <div class="grid gap-x-10 md:grid-cols-2">
            <div class="space-y-6">
              {
                speaker.data.specificationsLeft.map((spec) => (
                  <div>
                    <h3 class="font-bold text-neutral-800 dark:text-neutral-200">
                      {spec.title}
                    </h3>
                    <p class="text-neutral-600 dark:text-neutral-400">
                      {spec.subTitle}
                    </p>
                  </div>
                ))
              }
            </div>

            {
              speaker.data.specificationsRight ? (
                <div class="space-y-6">
                  {speaker.data.specificationsRight.map((spec) => (
                    <div>
                      <h3 class="font-bold text-neutral-800 dark:text-neutral-200">
                        {spec.title}
                      </h3>
                      <p class="text-neutral-600 dark:text-neutral-400">
                        {spec.subTitle}
                      </p>
                    </div>
                  ))}
                </div>
              ) : null
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<!-- TAB LOGIC (minimal JS) -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    // Use data-target attribute on each SpeakerTabBtn so this selects them.
    const buttons = Array.from(document.querySelectorAll('[data-target]'))
    const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'))

    const deactivate = () => {
      buttons.forEach((b) => {
        b.classList.remove('active', 'bg-neutral-100', 'dark:bg-white/[.05]')
        b.setAttribute('aria-selected', 'false')
      })
      panels.forEach((p) => p.classList.add('hidden'))
    }

    const activate = (button) => {
      const target = button.dataset.target
      if (!target) return
      const panel = document.querySelector(target)
      if (!panel) return

      deactivate()
      button.classList.add('active', 'bg-neutral-100', 'dark:bg-white/[.05]')
      button.setAttribute('aria-selected', 'true')
      panel.classList.remove('hidden')
    }

    if (buttons.length) {
      // activate first tab by default
      activate(buttons[0])
      buttons.forEach((btn) =>
        btn.addEventListener('click', (e) => {
          e.preventDefault()
          activate(btn)
        })
      )
    }
  })
</script>

<style>
  .speaker-clip {
    clip-path: polygon(75% 0%, 100% 50%, 75% 100%, 0% 100%, 25% 50%, 0% 0%);
  }

  @media (max-width: 640px) {
    .speaker-clip {
      clip-path: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .animate-fade-in-left,
    .animate-fade-in-right,
    .animate-fade-out {
      animation: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>
